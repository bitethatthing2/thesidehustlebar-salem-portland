# üîÑ Supabase Frontend Sync System

This guide explains how to keep your frontend perfectly synchronized with your Supabase database to prevent duplicates and ensure data consistency.

## üéØ Quick Start

### 1. Generate Latest Types
```bash
npm run types:generate
```

### 2. Check Database Sync
```bash
npm run db:check
```

### 3. Use Typed Functions
```typescript
import { useComments } from '@/hooks/useComments'
import { useLikes } from '@/hooks/useLikes'
import { usewolfpack_posts } from '@/hooks/usewolfpack_posts'
```

## üìã Table of Contents

1. [Architecture Overview](#architecture-overview)
2. [Type Safety System](#type-safety-system)
3. [Database Helper Functions](#database-helper-functions)
4. [React Hooks](#react-hooks)
5. [Real-time Sync](#real-time-sync)
6. [Migration Guide](#migration-guide)
7. [Best Practices](#best-practices)
8. [Troubleshooting](#troubleshooting)

## üèóÔ∏è Architecture Overview

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Components    ‚îÇ    ‚îÇ   React Hooks    ‚îÇ    ‚îÇ Database Layer  ‚îÇ
‚îÇ                 ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ                  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ                 ‚îÇ
‚îÇ VideoComments   ‚îÇ    ‚îÇ useComments      ‚îÇ    ‚îÇ comments.ts     ‚îÇ
‚îÇ LikeButton      ‚îÇ    ‚îÇ useLikes         ‚îÇ    ‚îÇ likes.ts        ‚îÇ
‚îÇ PostFeed        ‚îÇ    ‚îÇ usewolfpack_posts         ‚îÇ    ‚îÇ wolfpack_posts.ts        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ Typed Client     ‚îÇ
                    ‚îÇ /lib/supabase/   ‚îÇ
                    ‚îÇ client.ts        ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ Generated Types  ‚îÇ
                    ‚îÇ /types/          ‚îÇ
                    ‚îÇ database.types.ts‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üõ°Ô∏è Type Safety System

### Automatic Type Generation

Your `package.json` includes scripts that automatically generate TypeScript types:

```json
{
  "scripts": {
    "types:generate": "npx supabase gen types typescript --project-id tvnpgbjypnezoasbhbwx > types/database.types.ts",
    "prebuild": "npm run types:generate",
    "predev": "npm run types:generate"
  }
}
```

### Typed Supabase Client

The client in `/lib/supabase/client.ts` is now fully typed:

```typescript
import { Database } from '@/types/database.types'

const supabaseClient = createBrowserClient<Database>(
  supabaseUrl,
  supabaseAnonKey
)
```

## üóÑÔ∏è Database Helper Functions

### Comments (`/lib/database/comments.ts`)

```typescript
// ‚úÖ Correct table name and columns
await supabase
  .from('wolfpack_comments')
  .select('*, user:users!user_id(*)')
  .eq('video_id', postId) // ‚úÖ video_id, not video_id
```

### Likes (`/lib/database/likes.ts`)

```typescript
// ‚úÖ Correct table name
await supabase
  .from('wolfpack_post_likes') // ‚úÖ Not wolfpack_likes
  .select('*')
  .eq('video_id', postId)
```

### wolfpack_posts (`/lib/database/wolfpack_posts.ts`)

```typescript
// ‚úÖ Typed operations
const post: WolfpackVideo = await createPost({
  title: "My Video",
  video_url: "https://...",
  // TypeScript ensures all required fields
})
```

## ‚öõÔ∏è React Hooks

### useComments Hook

```typescript
function MyCommentsComponent({ postId }: { postId: string }) {
  const {
    comments,
    loading,
    error,
    addComment,
    editComment,
    removeComment,
    commentCount
  } = useComments(postId)

  const handleAddComment = async (content: string) => {
    try {
      await addComment(content)
      // Comments automatically updated!
    } catch (error) {
      // Handle error
    }
  }

  return (
    <div>
      {comments.map(comment => (
        <div key={comment.id}>
          {comment.content}
          {comment.user?.display_name}
        </div>
      ))}
    </div>
  )
}
```

### useLikes Hook

```typescript
function LikeButton({ postId }: { postId: string }) {
  const {
    liked,
    likeCount,
    loading,
    toggleLike,
    recentLikers
  } = useLikes(postId)

  return (
    <button 
      onClick={toggleLike}
      disabled={loading}
    >
      {liked ? '‚ù§Ô∏è' : 'ü§ç'} {likeCount}
    </button>
  )
}
```

### usewolfpack_posts Hook

```typescript
function FeedComponent() {
  const {
    wolfpack_posts,
    loading,
    hasMore,
    loadMore,
    createNewPost
  } = useFeedwolfpack_posts(20)

  return (
    <div>
      {wolfpack_posts.map(post => (
        <VideoCard key={post.id} post={post} />
      ))}
      {hasMore && (
        <button onClick={loadMore}>Load More</button>
      )}
    </div>
  )
}
```

## üîÑ Real-time Sync

### Real-time Comments

```typescript
import { useRealtimeComments } from '@/hooks/useRealtimeSync'

function CommentsSection({ postId }: { postId: string }) {
  const { comments, addComment } = useComments(postId)

  // Automatically sync new comments in real-time
  useRealtimeComments(
    postId,
    (newComment) => {
      // Real-time comment appears instantly
      console.log('New comment received:', newComment)
    }
  )

  return (
    // Component renders with real-time updates
    <div>{/* ... */}</div>
  )
}
```

### Real-time Likes

```typescript
import { useRealtimeLikes } from '@/hooks/useRealtimeSync'

function LikeCounter({ postId }: { postId: string }) {
  const { liked, likeCount } = useLikes(postId)

  // Automatically sync like changes
  useRealtimeLikes(
    postId,
    (liked, newCount) => {
      console.log('Like count updated:', newCount)
    }
  )

  return <span>{likeCount} likes</span>
}
```

## üîÑ Migration Guide

### From Old System to New System

#### 1. Replace Direct Supabase Calls

‚ùå **Old Way:**
```typescript
// Risky: Direct supabase calls without typing
const { data } = await supabase
  .from('wolfpack_comments')
  .select('*')
  .eq('video_id', postId) // ‚ùå Wrong column name!
```

‚úÖ **New Way:**
```typescript
// Safe: Typed function with correct schema
import { getCommentsForPost } from '@/lib/database/comments'

const comments = await getCommentsForPost(postId) // ‚úÖ Typed & correct
```

#### 2. Replace Custom Hooks

‚ùå **Old Way:**
```typescript
// Custom implementation with potential inconsistencies
const [comments, setComments] = useState([])
const [loading, setLoading] = useState(true)

useEffect(() => {
  // Manual fetching logic
}, [])
```

‚úÖ **New Way:**
```typescript
// Standardized hook with proper error handling
const { comments, loading, addComment } = useComments(postId)
```

#### 3. Replace Manual Real-time Setup

‚ùå **Old Way:**
```typescript
// Manual subscription management
useEffect(() => {
  const subscription = supabase
    .channel('comments')
    .on('postgres_changes', ...)
    .subscribe()
  
  return () => supabase.removeChannel(subscription)
}, [])
```

‚úÖ **New Way:**
```typescript
// Automatic real-time sync
useRealtimeComments(postId, onNewComment)
```

## üéØ Best Practices

### 1. Always Use TypeScript Types

```typescript
// ‚úÖ Use generated types
type Comment = Database['public']['Tables']['wolfpack_comments']['Row']

// ‚ùå Don't define custom interfaces that might drift
interface Comment { /* ... */ }
```

### 2. Use Database Helper Functions

```typescript
// ‚úÖ Use helper functions
import { createComment } from '@/lib/database/comments'
await createComment(postId, content)

// ‚ùå Don't make direct calls
await supabase.from('wolfpack_comments').insert({ /* ... */ })
```

### 3. Handle Errors Properly

```typescript
try {
  await addComment(content)
  toast.success('Comment added!')
} catch (error) {
  console.error('Comment error:', error)
  toast.error('Failed to add comment')
}
```

### 4. Use Optimistic Updates

The hooks automatically handle optimistic updates:

```typescript
// When you call toggleLike(), the UI updates immediately
// Then syncs with the server
const { toggleLike } = useLikes(postId)
await toggleLike() // UI updates instantly, then confirms with server
```

## üõ†Ô∏è Validation & Testing

### Check Database Sync

```bash
# Validate that frontend matches database
npm run db:check
```

This script verifies:
- ‚úÖ All required tables exist
- ‚úÖ Column names match your code
- ‚úÖ RPC functions are accessible
- ‚úÖ TypeScript types are up to date

### Update Types Before Development

```bash
# Always run before coding
npm run types:generate
npm run db:check
```

### Pre-deployment Checklist

```bash
# Run this before every deployment
npm run db:sync  # Generates types + validates sync
npm run type-check  # Validates TypeScript
npm run lint  # Code quality check
```

## üö® Troubleshooting

### Common Issues & Solutions

#### 1. "Table 'wolfpack_comments' does not exist"

**Solution:** Check your migrations
```bash
npx supabase status
npx supabase db push
```

#### 2. "Column 'video_id' does not exist"

**Solution:** Use correct column names
- ‚úÖ `video_id` (not `video_id`)
- ‚úÖ `wolfpack_post_likes` (not `wolfpack_likes`)

#### 3. TypeScript Errors

**Solution:** Regenerate types
```bash
npm run types:generate
```

#### 4. Real-time Not Working

**Solution:** Check subscriptions
```typescript
// Make sure you're using the hooks correctly
useRealtimeComments(postId, onNewComment) // ‚úÖ

// Not creating manual subscriptions
const subscription = supabase.channel(...) // ‚ùå
```

#### 5. Duplicate Data

**Solution:** Use the validation script
```bash
npm run db:check
```

The script will identify schema mismatches that cause duplicates.

## üìä Performance Tips

### 1. Use Pagination

```typescript
const { wolfpack_posts, loadMore, hasMore } = useFeedwolfpack_posts(20) // Load 20 at a time
```

### 2. Optimize Real-time Subscriptions

```typescript
// Only subscribe when component is visible
useRealtimeComments(
  postId,
  onNewComment,
  undefined,
  undefined,
  isVisible // enabled flag
)
```

### 3. Cache Queries

The hooks automatically cache data and avoid unnecessary refetches.

## üéâ Success Metrics

You'll know the sync system is working when:

- ‚úÖ **No TypeScript errors** in database operations
- ‚úÖ **No duplicate data** in your database
- ‚úÖ **Real-time updates** work seamlessly
- ‚úÖ **Consistent data** across all components
- ‚úÖ **Fast development** with autocomplete and type safety

## üîó Related Files

- `/lib/supabase/client.ts` - Typed Supabase client
- `/lib/database/*.ts` - Database helper functions
- `/hooks/use*.ts` - React hooks for data fetching
- `/hooks/useRealtimeSync.ts` - Real-time synchronization
- `/types/database.types.ts` - Generated TypeScript types
- `/scripts/check-database-sync.js` - Validation script

---

**Remember:** Always run `npm run db:sync` before development to ensure your frontend stays in perfect sync with Supabase! üöÄ